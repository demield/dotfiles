#!/bin/sh

APPLICATION_NAME="Disk Manager"
SUCCESS_MESSAGE="Successfuly unmounted \"%s\""
FAIL_MESSAGE="Failed to unmount \"%s\""

if [ "$XDG_SESSION_DESKTOP" == "i3" ]; then
  SELECT_COMMAND="dmenu"
elif [ "$XDG_SESSION_DESKTOP" == "sway" ]; then
  SELECT_COMMAND="wofi -c \"$HOME/.config/wofi/trs_config\" --dmenu"
else
  notify-send -a "$APPLICATION_NAME" "Not an i3/sway environment"
fi

PARTITIONS="$(\
  df 2>/dev/null \
  | grep -E 'sd[^a][0-9]+' \
  | sed 's/\ \ */\ /g' \
  | awk '{ if ($6) { print $1} }')"

test ! -z "$PARTITIONS" && { \
  PARTITION_PATH=$(echo "$PARTITIONS" | eval "$SELECT_COMMAND");
  test ! -z "$PARTITION_PATH" && { \
    udisksctl unmount -b "$PARTITION_PATH" \
    && notify-send -a "$APPLICATION_NAME" "$(printf "$SUCCESS_MESSAGE" "$PARTITION_PATH")" \
    || notify-send -a "$APPLICATION_NAME" "$(printf "$FAIL_MESSAGE" "$PARTITION_PATH")"; } } \
  || notify-send -a "$APPLICATION_NAME" "No mounted partitions"

unset APPLICATION_NAME
unset SUCCESS_MESSAGE
unset FAIL_MESSAGE
unset SELECT_COMMAND
unset PARTITIONS
unset PARTITION_PATH

